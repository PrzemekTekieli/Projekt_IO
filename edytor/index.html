<!DOCTYPE html>
<html>
	<head>
		<title>Edytor</title>
		<meta http-equiv="content-type" content="text/html; charset=utf-8">
		<style>
			.d-inline-block{
				display:inline-block;
			}
			.v-align-top{
				vertical-align:top;
			}
			.m-1{
				margin:5px;
			}
			.mx-3{
				margin-left:15px;
				margin-right:15px;
			}
			.f-left{
				float:left;
			}
			.f-right{
				float:right;
			}
			.button{
				padding:10px;
				margin:5px;
				background:green;
				color:#fff;
				cursor:pointer;
				text-align:center;
				font-size:20px;
			}
			#message{
				text-align:center;
				min-height:18px;
			}
			#message h4{
				margin:0;
			}
			.error{
				color:#ff0000;
			}
			.active{
				background:blue;
			}
			.row{
				overflow:hidden;
			}
		</style>
		<script src="lib.js"></script>
		<script>
		
			//zmienne globalne
			
			//tablica przycisków tworzonych przy starcie strony, name - wyświetlana nazwa, command - wysyłana komenda do serwera po kliknięciu
			var buttons = [
				{
					name:"Gracze",
					command:"player",
					show:["login"]
				},
				{
					name:"Postacie",
					command:"character",
					show:["nazwa"]
				},
				{
					name:"Potwory",
					command:"enemy",
					show:["nazwa"]
				},
				{
					name:"Ekwipunek",
					command:"inventory",
					show:["nazwa"]//przerobić żeby postac miała nazwę jako klucz główny?
				},
				{
					name:"Lokacje",
					command:"location",
					show:["x","y"]
				},
				{
					name:"Misje",
					command:"mission",
					show:["nazwa"]//dodać do misji nazwę oprócz opisu
				}
			];
			
			var variables;
			
			//funkcja wywoływana po załadowaniu strony
			function start(){
				setVariables();
				createButtons();
			}
			
			function setVariables(){
				variables = new Object();
				for(var i = 0; i < buttons.length; i++){
					variables[buttons[i].name] = '';
				}
			}
			
			//będą jakby 3 poziomy edytora:
			//1. wybór głównej kategorii, np. przeciwnicy
			//2. wybór konkretnego przeciwnika
			//3. formularz edycji wybranego przeciwnika
			
			
			//tworzy przyciski na podstawie tablicy 'buttons'
			function createButtons(){
				for(var i = 0; i < buttons.length; i++){
					var btn = $create('','button',buttons[i].name);
					$setAtr(btn,'cmd',buttons[i].command);
					$setAtr(btn,'id',i);
					$get('#buttons-container').appendChild(btn);
					
					//po kliknięciu przycisku wysyłamy AJAX żeby pobrać odpowiednie rzeczy na podstawie wysłanej komendy
					btn.addEventListener('click',function(index){
						var actives = $get('#step1 .active');
						for(var i = 0; i < actives.length; i++){
							$removeClass(actives[i],'active');
						}
						var index = $getAtr(this,'id');
						$addClass(this,'active');
						$get('#cur-content-name').innerHTML = '(' + this.innerHTML + ')';
						var url = 'http://www.xampp.fl/IO_edytor/cmd.php';//trzeba ustawić własny url do pliku
						$ajax(url,'?action=' + $getAtr(this,'cmd'),createContent, buttons[index].name, buttons[index].show);
					});
				}
			}
			
			var createContent = function(server, obj_name, show_name){
				//pobraliśmy wszystko z danej kategorii, więc wyświetlamy to w formie przycisków, aby móc edytować konkrety rekord
				var response = JSON.parse(server.response);			

				$get("#contents-container").innerHTML = '';
				$get("#element-container").innerHTML = '';
				
				//jeśli to nie jest tablica, to znaczy że wystąpił błąd nieznanej komendy
				if(!Array.isArray(response)){
					$get("#message").innerHTML = '<div class="error"><h4>' + response + '</h4></div>';
					return;
				}
				$get("#message").innerHTML = '#';
				
				//przepisujemy zawartość odpowiedzi do zmiennej
				variables[obj_name] = response;
				
				for(var i = 0; i < response.length; i++){
					var str = '';
					for(var j = 0; j < show_name.length; j++){
						str += response[i][show_name[j]] + ',';
					}
					str = str.slice(0,-1);//żeby usunąć ostatni przecinek
					var btn = $create('', 'button', str);
					$setAtr(btn,'id',i);
					$get("#contents-container").appendChild(btn);
					
					btn.addEventListener('click',function(){
						var actives = $get('#step2 .active');
						for(var i = 0; i < actives.length; i++){
							$removeClass(actives[i],'active');
						}
						var index = $getAtr(this,'id');
						$addClass(this,'active');
						$get('#cur-element-name').innerHTML = '(' + this.innerHTML + ')';
						editData(variables[obj_name][index]);
					});
				}
				
				/*
				for(var i = 0; i < response.length; i++){
					var btn = $create('','button',response[i][1]);//TODO response[i][1] jakoś uzmiennić, bo nie wszędzie tam jest coś godnego wyświetlenia
					$get("#contents-container").appendChild(btn);
				}
				*/
			}
			
			function editData(data){
				var form_container = $get("#element-container");
				form_container.innerHTML = '';
				for (var key in data){
					var row = $create('','row');
					var label = $create('','f-left m-1',key,'label');
					var input = $create('','f-right m-1','','input');
					input.value = data[key];
					row.appendChild(label);
					row.appendChild(input);
					form_container.appendChild(row);
				}
			}
		</script>
	</head>
	<body onload="start()">

		<div>
			<h1 style='text-align:center;'>Edytor</div>
			<div id="message"></div>
			<div id="step1" class="d-inline-block v-align-top mx-3">
				<h2>Zawartości do edycji:</h2>
				<div id="buttons-container" class="d-inline-block"></div>
			</div>
			<div id="step2" class="d-inline-block v-align-top mx-3">
				<h2>Wybrana zawartość: <span id="cur-content-name"></span></h2>
				<div id="contents-container" class="d-inline-block"></div>
			</div>
			<div id="step3" class="d-inline-block v-align-top mx-3">
				<h2>Edytowany element: <span id="cur-element-name"></span></h2>
				<div id="element-container" class="d-inline-block"></div>
			</div>
		</div>

	</body>
</html>